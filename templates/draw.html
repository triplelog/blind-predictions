<!DOCTYPE html>

	
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Electoral Map</title>
<link rel="icon" type="image/png" href="../img/fav.png">
<meta name="description" content=""/>



  <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet">

  <!-- Custom styles for this template-->
  <link href="css/map.css" rel="stylesheet">
  <link href="css/slider.css" rel="stylesheet">
  
      <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
	
<style>
body {
	display: flex;
	flex-direction: row;
}
.menu {
	flex: 1;
	border: 1px solid red;
	height: 95vh;
	overflow-y: auto;
}
.gridHolder {
	
	display: flex;
	flex-direction: column;
	width: 95vw;
	height: 95vh;
	border: 1px solid black;
	margin: auto;
}

.gridRow {
	flex: 1;
	display: flex;
	flex-direction: row;
}
.gridCell {
	border:1px dotted black;
	flex: 1;
	text-align: center;
	line-height: calc(95vh / 20);
}
@media (max-aspect-ratio: 4/3) {
	.gridHolder {
		height: calc( 95vw * 19 / 24);
	}
	.gridCell {
		line-height: calc(95vw * 19 / 24 / 20);
	}
}
@media (min-aspect-ratio: 4/3) {
	.gridHolder {
		width: calc( 95vh * 24 / 19);
	}
}
</style>

</head>
<body>

	<div class="menu">
	<button onclick="displaySVG()">Print</button>
	{% for i in range(0,50) %}
		{% set x = states[i].ev10 - 2 %}
		<div id="state-{{ states[i].abbrev }}">{{ states[i].abbrev }}: <span class="cellsDrawn">0</span><span> of {{ x }}</span></div>
	{% endfor %}
	</div>
	<div class="gridHolder">
	{% for ii in range(0,18) %}
		<div class="gridRow">
		{% for i in range(0,25) %}
			<div class="gridCell" draggable="true" data-row="{{ ii }}" data-col="{{ i }}">
			</div>
		{% endfor %}
		</div>
	{% endfor %}
	</div>

  



</body>
<script>
var currentState = "";
var cells = {};
var svgs = {};
var els = document.querySelectorAll('.gridCell');
for (var i=0;i<els.length;i++){
	els[i].addEventListener('click',clickCell);
	els[i].addEventListener('dragstart',clickCell);
	els[i].addEventListener('dragenter',clickCell);
}

var states = {{ states | dump | safe}};
for (var i=0;i<50;i++){
	var el = document.getElementById('state-'+states[i].abbrev);
	el.addEventListener('click',clickState);
	cells[states[i].abbrev]=[];
	svgs[states[i].abbrev]={'allPaths':[],'points':[],'borders':[]};
}

function clickCell(evt){

	var r = parseInt(evt.target.getAttribute('data-row'));
	var c = parseInt(evt.target.getAttribute('data-col'));
	var modified = {};
	for (var i=0;i<50;i++){
		var cl = cells[states[i].abbrev];
		
		for (var ii=0;ii<cl.length;ii++){
			if (cl[ii][0] == r && cl[ii][1] == c){
				cl.splice(ii,1);
				modified[states[i].abbrev]=true;
				
				ii--;
			}
		}
	}
	
	
	if (currentState != ""){
		cells[currentState].push([r,c,evt.target]);
		modified[currentState]=true;
	}
	
	for (var mod in modified){
		var el = document.getElementById('state-'+mod);
		el.querySelector('.cellsDrawn').textContent = cells[mod].length;
		var cl = cells[mod];
		svgs[mod].points = [];
		svgs[mod].borders = [];
		svgs[mod].allPaths = [];
		var tempPoints = {};
		var tempPaths = {};
		for (var i=0;i<cl.length;i++){
			cl[i][2].style.borderLeft = "1px solid red";
			cl[i][2].style.borderRight = "1px solid red";
			cl[i][2].style.borderTop = "1px solid red";
			cl[i][2].style.borderBottom = "1px solid red";
			cl[i][2].textContent = mod.toUpperCase();
			if (tempPaths["M "+cl[i][1] +" "+ cl[i][0] + " L "+(cl[i][1]+1) +" "+ cl[i][0] ]){
				tempPaths["M "+cl[i][1] +" "+ cl[i][0] + " L "+(cl[i][1]+1) +" "+ cl[i][0] ]++;
			}
			else {
				tempPaths["M "+cl[i][1] +" "+ cl[i][0] + " L "+(cl[i][1]+1) +" "+ (cl[i][0]) ]=1;
			}
			
			if (tempPaths["M "+cl[i][1] +" "+ cl[i][0] + " L "+(cl[i][1]) +" "+ (cl[i][0]+1) ]){
				tempPaths["M "+cl[i][1] +" "+ cl[i][0] + " L "+(cl[i][1]) +" "+ (cl[i][0]+1) ]++;
			}
			else {
				tempPaths["M "+cl[i][1] +" "+ cl[i][0] + " L "+(cl[i][1]) +" "+ (cl[i][0]+1) ]=1;
			}
			
			if (tempPaths["M "+(cl[i][1]+1) +" "+ cl[i][0] + " L "+(cl[i][1]+1) +" "+ (cl[i][0]+1) ]){
				tempPaths["M "+(cl[i][1]+1) +" "+ cl[i][0] + " L "+(cl[i][1]+1) +" "+ (cl[i][0]+1) ]++;
			}
			else {
				tempPaths["M "+(cl[i][1]+1) +" "+ cl[i][0] + " L "+(cl[i][1]+1) +" "+ (cl[i][0]+1) ]=1;
			}
			
			if (tempPaths["M "+cl[i][1] +" "+ (cl[i][0]+1) + " L "+(cl[i][1]+1) +" "+ (cl[i][0]+1) ]){
				tempPaths["M "+cl[i][1] +" "+ (cl[i][0]+1) + " L "+(cl[i][1]+1) +" "+ (cl[i][0]+1) ]++;
			}
			else {
				tempPaths["M "+cl[i][1] +" "+ (cl[i][0]+1) + " L "+(cl[i][1]+1) +" "+ (cl[i][0]+1) ]=1;
			}
		}
		for (var i=0;i<cl.length;i++){
			for (var ii=0;ii<cl.length;ii++){
				if (cl[i][0] == cl[ii][0] -1 && cl[i][1] == cl[ii][1]){
					cl[i][2].style.borderBottom = "1px solid transparent";
					cl[ii][2].style.borderTop = "1px solid transparent";
					if (tempPoints[""+cl[ii][0] +"-"+ cl[ii][1]]){
						tempPoints[""+cl[ii][0] +"-"+ cl[ii][1]]++;
					}
					else {
						tempPoints[""+cl[ii][0] +"-"+ cl[ii][1]]=1;
					}
					if (tempPoints[""+cl[ii][0] +"-"+ (cl[ii][1]+1)]){
						tempPoints[""+cl[ii][0] +"-"+ (cl[ii][1]+1)]++;
					}
					else {
						tempPoints[""+cl[ii][0] +"-"+ (cl[ii][1]+1)]=1;
					}
					svgs[mod].borders.push([cl[ii][0],cl[ii][1]+0.25]);
					svgs[mod].borders.push([cl[ii][0],cl[ii][1]+0.5]);
					svgs[mod].borders.push([cl[ii][0],cl[ii][1]+0.75]);
				}
				if (cl[i][1] == cl[ii][1] -1 && cl[i][0] == cl[ii][0]){
					cl[i][2].style.borderRight = "1px solid transparent";
					cl[ii][2].style.borderLeft = "1px solid transparent";
					if (tempPoints[""+cl[ii][0] +"-"+ cl[ii][1]]){
						tempPoints[""+cl[ii][0] +"-"+ cl[ii][1]]++;
					}
					else {
						tempPoints[""+cl[ii][0] +"-"+ cl[ii][1]]=1;
					}
					if (tempPoints[""+(cl[ii][0]+1) +"-"+ cl[ii][1]]){
						tempPoints[""+(cl[ii][0]+1) +"-"+ cl[ii][1]]++;
					}
					else {
						tempPoints[""+(cl[ii][0]+1) +"-"+ cl[ii][1]]=1;
					}
					svgs[mod].borders.push([cl[ii][0]+0.25,cl[ii][1]]);
					svgs[mod].borders.push([cl[ii][0]+0.5,cl[ii][1]]);
					svgs[mod].borders.push([cl[ii][0]+0.75,cl[ii][1]]);
				}
			}
		}
		for (point in tempPoints){
			if (tempPoints[point]== 4){
				var row = parseInt(point.split("-")[0]);
				var col = parseInt(point.split("-")[1]);
				svgs[mod].points.push([row,col]);
			}
		}
		var allPaths = [];
		for (path in tempPaths){
			if (tempPaths[path]== 1){
				allPaths.push(path);
			}
		}
		
		svgs[mod].allPaths = allPaths;
		
		
	}
	
}
function clickState(evt){
	var el = evt.target;
	while (el.parentElement && (!el.id || el.id.substr(0,6) != "state-") ){
		el = el.parentElement;
	}
	for (var i=0;i<50;i++){
		var e = document.getElementById('state-'+states[i].abbrev);
		e.style.background = "white";
	}
	currentState = el.id.substr(6);
	el.style.background = "gray";
}

function displaySVG(){
	var svg = '<svg viewBox="-1 -1 26 21" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"  version="1.2" baseProfile="tiny">';
	for (state in svgs){
		var allPaths = [];
		for (var i=0;i<svgs[state].allPaths.length;i++){
			allPaths.push(svgs[state].allPaths[i]);
		}
		if (allPaths.length == 0){
			continue;
		}
		var path = allPaths[0];
		var lastPoint = allPaths[0].split("L")[1];
		allPaths.splice(0,1);
		var counter = 0;
		while (counter < 10000 && allPaths.length > 0){
			for (var i=0;i<allPaths.length;i++){
				var firstPoint = allPaths[i].split("L")[0];
				if (firstPoint == "M"+lastPoint+" "){
					path += " "+allPaths[i];
					lastPoint = allPaths[i].split("L")[1];
					allPaths.splice(i,1);
					break;
				}
				var firstPoint = allPaths[i].split("L")[1];
				if (firstPoint == lastPoint){
					lastPoint = allPaths[i].split("L")[0].substr(1);
					lastPoint = lastPoint.substr(0,lastPoint.length-1);
					var newPath = "M"+firstPoint+" L"+lastPoint;
					path += " " + newPath;
					allPaths.splice(i,1);
					break;
				}
			}
			counter++;
		}
		svg += '<g id="state-'+state+'" fill-rule="evenodd" stroke-linecap="square" stroke-linejoin="bevel">';
		svg += '<path fill="transparent" stroke="black" stroke-width=".1" d="'+path+'"/>';
		
		for (border in svgs[state].borders){
			svg += '<circle r=".05" cx="'+svgs[state].borders[border][1]+'" cy="'+svgs[state].borders[border][0]+'"/>';
		}
		for (point in svgs[state].points){
			svg += '<circle r=".1" cx="'+svgs[state].points[point][1]+'" cy="'+svgs[state].points[point][0]+'"/>';
		}
		cells[state].sort(function(a,b){return a[0]*10000+a[1] - (b[0]*10000+b[1])});
		var idx = 1;
		for (cell in cells[state]){
			var cellPath = 'M'+cells[state][cell][1]+','+cells[state][cell][0];
			cellPath += ' L'+cells[state][cell][1]+','+(cells[state][cell][0]+1);
			cellPath += ' L'+(cells[state][cell][1]+1)+','+(cells[state][cell][0]+1);
			cellPath += ' L'+(cells[state][cell][1]+1)+','+cells[state][cell][0];
			cellPath += ' L'+cells[state][cell][1]+','+cells[state][cell][0];
			if (cells[state].length == 1){idx = 0;}
			svg += '<path onclick="clickdistrict('+"'"+state+'-'+idx+"'"+')" id="'+state+'-'+idx+'" stroke-width="0" fill="white" vector-effect="none" fill-rule="evenodd" d="'+cellPath+'"/>';
			idx++;
		}
		svg += '</g>';
	}
	svg += "</svg>";
	console.log(svg);
}
</script>


</html>





