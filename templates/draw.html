<!DOCTYPE html>

	
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Electoral Map</title>
<link rel="icon" type="image/png" href="../img/fav.png">
<meta name="description" content=""/>



  <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet">

  <!-- Custom styles for this template-->
  <link href="css/map.css" rel="stylesheet">
  <link href="css/slider.css" rel="stylesheet">
  
      <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
	
<style>
body {
	display: flex;
	flex-direction: row;
}
.menu {
	flex: 1;
	border: 1px solid red;
	height: 95vh;
	overflow-y: auto;
}
.gridHolder {
	
	display: flex;
	flex-direction: column;
	width: 95vw;
	height: 95vh;
	border: 1px solid black;
	margin: auto;
}

.gridRow {
	flex: 1;
	display: flex;
	flex-direction: row;
}
.gridCell {
	border:1px dotted black;
	flex: 1;
	text-align: center;
	line-height: calc(95vh / {{ height + 2 }});
	font-size: .4rem;
}
@media (max-aspect-ratio: {{ width }}/{{ height }}) {
	.gridHolder {
		height: calc( 95vw * {{ height }} / {{ width }});
	}
	.gridCell {
		line-height: calc(95vw * {{ height }} / {{ width }} / {{ height + 2}});
	}
}
@media (min-aspect-ratio: {{ width }}/{{ height }}) {
	.gridHolder {
		width: calc( 95vh * {{ width }} / {{ height }});
	}
}
</style>

</head>
<body>

	<div class="menu">
	<button onclick="displaySVG()">Print</button>
	{% for i in range(0,states.length) %}
		{% set x = states[i][val] %}
		<div id="state-{{ states[i].abbrev }}">{{ states[i].abbrev }}: <span class="cellsDrawn">0</span><span> of {{ x }}</span></div>
	{% endfor %}
	

	</div>
	<div class="gridHolder">
	{% for ii in range(0,height) %}
		<div class="gridRow">
		{% for i in range(0,width) %}
			<div class="gridCell" draggable="true" data-row="{{ ii }}" data-col="{{ i }}">
			</div>
		{% endfor %}
		</div>
	{% endfor %}
	</div>

  



</body>
<script>
var currentState = "";
var cells = {};
var svgs = {};

var els = document.querySelectorAll('.gridCell');
for (var i=0;i<els.length;i++){
	els[i].addEventListener('click',clickCell);
	els[i].addEventListener('dragstart',clickCell);
	els[i].addEventListener('dragenter',clickCell);
}

var states = {{ states | dump | safe}};
for (var i=0;i<states.length;i++){
	var el = document.getElementById('state-'+states[i].abbrev);
	el.addEventListener('click',clickState);
	cells[states[i].abbrev]=[];
	svgs[states[i].abbrev]={'allPaths':[],'points':[],'borders':[]};
}
cells = JSON.parse(localStorage.getItem('savedcells{{ load }}'));
svgs = JSON.parse(localStorage.getItem('savedsvgs{{ load }}'));
var districts = true;
{% if districts %}
{% else %}
districts = false;
{% endif %}

if (cells && svgs){
	for (var i=0;i<states.length;i++){
		if (cells[states[i].abbrev].length>0 || svgs[states[i].abbrev].allPaths.length>0 || svgs[states[i].abbrev].points.length>0 || svgs[states[i].abbrev].borders.length>0){
		
			for (var ii=0;ii<cells[states[i].abbrev].length;ii++){
				var sel = '[data-row="'+cells[states[i].abbrev][ii][0]+'"][data-col="'+cells[states[i].abbrev][ii][1]+'"]';
				cells[states[i].abbrev][ii][2]=document.querySelector(sel);
			}
			updatePaths(states[i].abbrev);
		}

	}
}
else {
	cells = {};
	svgs = {};
	for (var i=0;i<states.length;i++){
		cells[states[i].abbrev]=[];
		svgs[states[i].abbrev]={'allPaths':[],'points':[],'borders':[]};
	}
}

function updatePaths(state) {
	var el = document.getElementById('state-'+state);
	el.querySelector('.cellsDrawn').textContent = cells[state].length;
	var cl = cells[state];
	svgs[state].points = [];
	svgs[state].borders = [];
	svgs[state].allPaths = [];
	var tempPoints = {};
	var tempPaths = {};
	for (var i=0;i<cl.length;i++){
		cl[i][2].style.borderLeft = "1px solid red";
		cl[i][2].style.borderRight = "1px solid red";
		cl[i][2].style.borderTop = "1px solid red";
		cl[i][2].style.borderBottom = "1px solid red";
		cl[i][2].textContent = state.toUpperCase().substr(0,3);
		cl[i][3][0]=false;
		cl[i][3][1]=false;
		cl[i][3][2]=false;
		cl[i][3][3]=false;
		if (tempPaths["M"+cl[i][1] +","+ cl[i][0] + " L"+(cl[i][1]+1) +","+ cl[i][0] ]){
			tempPaths["M"+cl[i][1] +","+ cl[i][0] + " L"+(cl[i][1]+1) +","+ cl[i][0] ]++;
		}
		else {
			tempPaths["M"+cl[i][1] +","+ cl[i][0] + " L"+(cl[i][1]+1) +","+ (cl[i][0]) ]=1;
		}
		
		if (tempPaths["M"+cl[i][1] +","+ cl[i][0] + " L"+(cl[i][1]) +","+ (cl[i][0]+1) ]){
			tempPaths["M"+cl[i][1] +","+ cl[i][0] + " L"+(cl[i][1]) +","+ (cl[i][0]+1) ]++;
		}
		else {
			tempPaths["M"+cl[i][1] +","+ cl[i][0] + " L"+(cl[i][1]) +","+ (cl[i][0]+1) ]=1;
		}
		
		if (tempPaths["M"+(cl[i][1]+1) +","+ cl[i][0] + " L"+(cl[i][1]+1) +","+ (cl[i][0]+1) ]){
			tempPaths["M"+(cl[i][1]+1) +","+ cl[i][0] + " L"+(cl[i][1]+1) +","+ (cl[i][0]+1) ]++;
		}
		else {
			tempPaths["M"+(cl[i][1]+1) +","+ cl[i][0] + " L"+(cl[i][1]+1) +","+ (cl[i][0]+1) ]=1;
		}
		
		if (tempPaths["M"+cl[i][1] +","+ (cl[i][0]+1) + " L"+(cl[i][1]+1) +","+ (cl[i][0]+1) ]){
			tempPaths["M"+cl[i][1] +","+ (cl[i][0]+1) + " L"+(cl[i][1]+1) +","+ (cl[i][0]+1) ]++;
		}
		else {
			tempPaths["M"+cl[i][1] +","+ (cl[i][0]+1) + " L"+(cl[i][1]+1) +","+ (cl[i][0]+1) ]=1;
		}
	}
	for (var i=0;i<cl.length;i++){
		for (var ii=0;ii<cl.length;ii++){
			if (cl[i][0] == cl[ii][0] -1 && cl[i][1] == cl[ii][1]){
				cl[i][2].style.borderBottom = "1px solid transparent";
				cl[ii][2].style.borderTop = "1px solid transparent";
				cl[i][3][2]=true;
				cl[ii][3][0]=true;
				if (tempPoints[""+cl[ii][0] +"-"+ cl[ii][1]]){
					tempPoints[""+cl[ii][0] +"-"+ cl[ii][1]]++;
				}
				else {
					tempPoints[""+cl[ii][0] +"-"+ cl[ii][1]]=1;
				}
				if (tempPoints[""+cl[ii][0] +"-"+ (cl[ii][1]+1)]){
					tempPoints[""+cl[ii][0] +"-"+ (cl[ii][1]+1)]++;
				}
				else {
					tempPoints[""+cl[ii][0] +"-"+ (cl[ii][1]+1)]=1;
				}
				svgs[state].borders.push([cl[ii][0],cl[ii][1]+0.25]);
				svgs[state].borders.push([cl[ii][0],cl[ii][1]+0.5]);
				svgs[state].borders.push([cl[ii][0],cl[ii][1]+0.75]);
			}
			if (cl[i][1] == cl[ii][1] -1 && cl[i][0] == cl[ii][0]){
				cl[i][2].style.borderRight = "1px solid transparent";
				cl[ii][2].style.borderLeft = "1px solid transparent";
				cl[i][3][1]=true;
				cl[ii][3][3]=true;
				if (tempPoints[""+cl[ii][0] +"-"+ cl[ii][1]]){
					tempPoints[""+cl[ii][0] +"-"+ cl[ii][1]]++;
				}
				else {
					tempPoints[""+cl[ii][0] +"-"+ cl[ii][1]]=1;
				}
				if (tempPoints[""+(cl[ii][0]+1) +"-"+ cl[ii][1]]){
					tempPoints[""+(cl[ii][0]+1) +"-"+ cl[ii][1]]++;
				}
				else {
					tempPoints[""+(cl[ii][0]+1) +"-"+ cl[ii][1]]=1;
				}
				svgs[state].borders.push([cl[ii][0]+0.25,cl[ii][1]]);
				svgs[state].borders.push([cl[ii][0]+0.5,cl[ii][1]]);
				svgs[state].borders.push([cl[ii][0]+0.75,cl[ii][1]]);
			}
		}
	}
	for (point in tempPoints){
		if (tempPoints[point]== 4){
			var row = parseInt(point.split("-")[0]);
			var col = parseInt(point.split("-")[1]);
			svgs[state].points.push([row,col]);
		}
	}
	var allPaths = [];
	for (path in tempPaths){
		if (tempPaths[path]== 1){
			allPaths.push(path);
		}
	}
	
	svgs[state].allPaths = allPaths;
	
	

}

function clickCell(evt){

	var r = parseInt(evt.target.getAttribute('data-row'));
	var c = parseInt(evt.target.getAttribute('data-col'));
	var modified = {};
	for (var i=0;i<states.length;i++){
		var cl = cells[states[i].abbrev];
		
		for (var ii=0;ii<cl.length;ii++){
			if (cl[ii][0] == r && cl[ii][1] == c){
				cl.splice(ii,1);
				modified[states[i].abbrev]=true;
				
				ii--;
			}
		}
	}
	
	
	if (currentState != ""){
		cells[currentState].push([r,c,evt.target,[false,false,false,false]]);
		modified[currentState]=true;
	}
	
	for (var mod in modified){
		updatePaths(mod);
	}
	
}
function clickState(evt){
	var el = evt.target;
	while (el.parentElement && (!el.id || el.id.substr(0,6) != "state-") ){
		el = el.parentElement;
	}
	for (var i=0;i<states.length;i++){
		var e = document.getElementById('state-'+states[i].abbrev);
		e.style.background = "white";
	}
	currentState = el.id.substr(6);
	el.style.background = "gray";
}

function displaySVG(){
	var svg = '<svg viewBox="-1 -1 26 21" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"  version="1.2" baseProfile="tiny">';
	svg ='';
	for (state in svgs){
		var allPaths = [];
		for (var i=0;i<svgs[state].allPaths.length;i++){
			allPaths.push(svgs[state].allPaths[i]);
		}
		if (allPaths.length == 0){
			continue;
		}
		var path = allPaths[0];
		var lastPoint = allPaths[0].split("L")[1];
		allPaths.splice(0,1);
		var counter = 0;

		while (counter < 10000 && allPaths.length > 0){
			for (var i=0;i<allPaths.length;i++){
				var firstPoint = allPaths[i].split("L")[0];
				if (firstPoint == "M"+lastPoint+" "){
					
					lastPoint = allPaths[i].split("L")[1];
					path += " L"+lastPoint;
					allPaths.splice(i,1);
					break;
				}
				var firstPoint = allPaths[i].split("L")[1];
				if (firstPoint == lastPoint){
					lastPoint = allPaths[i].split("L")[0].substr(1);
					lastPoint = lastPoint.substr(0,lastPoint.length-1);
					var newPath = " L"+lastPoint;
					path += newPath;
					allPaths.splice(i,1);
					break;
				}
			}
			counter++;
		}
		svg += '<g id="state-'+state+'" fill-rule="evenodd" stroke-linecap="square" stroke-linejoin="bevel">';
		var rwin = -1;
		var half = 0;
		for (var i=0;i<states.length;i++){
			if (states[i].abbrev == state){
				if (states[i].rwin || states[i].rwin == 0){
					rwin = states[i].rwin;
					if (states[i].half){
						half = 1;
					}
					break;
				}
			}
		}
		if (rwin > -1 && rwin < .5){
			if (half > 0){
				svg += '<path fill="hsl(240,100%,'+(50+(rwin)*100)+'%)" stroke="white" stroke-width=".25" d="'+path+'"/>';
			}
			else {
				svg += '<path fill="hsl(240,100%,'+(50+(rwin)*100)+'%)" stroke="white" stroke-width=".125" d="'+path+'"/>';
			}
			
		}
		else if (rwin > -1 && rwin > .5){
			if (half > 0){
				svg += '<path fill="hsl(0,100%,'+(50+(1-rwin)*100)+'%)" stroke="white" stroke-width=".25" d="'+path+'"/>';
			}
			else {
				svg += '<path fill="hsl(0,100%,'+(50+(1-rwin)*100)+'%)" stroke="white" stroke-width=".125" d="'+path+'"/>';
			}
			
		}
		else {
			svg += '<path fill="black" stroke="white" stroke-width=".125" d="'+path+'"/>';
		}
		
		for (border in svgs[state].borders){
			//svg += '<circle r=".05" fill="gray" stroke="black" stroke-width="0" cx="'+svgs[state].borders[border][1]+'" cy="'+svgs[state].borders[border][0]+'"/>';
		}
		for (point in svgs[state].points){
			//svg += '<circle r=".05" fill="gray" stroke="black" stroke-width="0" cx="'+svgs[state].points[point][1]+'" cy="'+svgs[state].points[point][0]+'"/>';
		}
		cells[state].sort(function(a,b){return a[0]*10000+a[1] - (b[0]*10000+b[1])});
		var idx = 1;
		var margin = .15;
		for (cell in cells[state]){
			var xMin = cells[state][cell][1]+margin;
			var xMax = cells[state][cell][1]+1-margin;
			var yMin = cells[state][cell][0]+margin;
			var yMax = cells[state][cell][0]+1-margin;
			if (cells[state][cell][3][0]){
				yMin = cells[state][cell][0]+margin/2.4;
			}
			if (cells[state][cell][3][1]){
				xMax = cells[state][cell][1]+1-margin/2.4;
			}
			if (cells[state][cell][3][2]){
				yMax = cells[state][cell][0]+1-margin/2.4;
			}
			if (cells[state][cell][3][3]){
				xMin = cells[state][cell][1]+margin/2.4;
			}
			var cellPath = 'M'+xMin+','+yMin;
			cellPath += ' L'+xMin+','+yMax;
			cellPath += ' L'+xMax+','+yMax;
			cellPath += ' L'+xMax+','+yMin;
			cellPath += ' L'+xMin+','+yMin;
			if (cells[state].length == 1){idx = 0;}
			if (districts){
				svg += '<path onclick="clickdistrict('+"'"+state+'-'+idx+"'"+')" id="'+state+'-'+idx+'" stroke-width="0" fill="black" d="'+cellPath+'"/>';
			}
			if (idx < 2){
				svg += '<text font-size=".5" text-anchor="middle" x="'+(cells[state][cell][1]+.5)+'" y="'+(cells[state][cell][0]+.5)+'">'+state+'</text>';
			}
			
			idx++;
		}
		svg += '</g>';
	}

	//svg += "</svg>";
	console.log(svg);
	localStorage.setItem('savedsvgs{{ saveAs }}', JSON.stringify(svgs));
	localStorage.setItem('savedcells{{ saveAs }}', JSON.stringify(cells));
}
</script>


</html>





